<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <link rel="icon" href="Img/4.png" />
  <title>¡Supérate! — Chatbot</title>
  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: 'Segoe UI', sans-serif;
      display: flex;
      flex-direction: column;
      height: 100vh;
      background: #f4f4f5;
    }
    header {
      height: 60px;
      background: #00B8FF;
      padding: 10px 20px;
      display: flex;
      align-items: center;
      box-shadow: 0 1px 4px rgba(0,0,0,0.1);
      justify-content: space-between;
    }
    .header-image {
      height: 160px;
    }
    .history-btn {
      background: #ffffff;
      border: none;
      color: rgb(0, 0, 0);
      padding: 6px 12px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.9rem;
    }
    .chat-container {
      flex: 1;
      padding: 20px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .message {
      max-width: 80%;
      padding: 12px 16px;
      border-radius: 18px;
      font-size: 1rem;
      line-height: 1.4;
      white-space: pre-wrap;
      animation: fadeIn 0.3s ease;
    }
    .user-message {
      background-color: #4a90e2;
      color: white;
      align-self: flex-end;
      border-top-right-radius: 0;
    }
    .bot-message {
      background-color: #e0e0e0;
      color: #111;
      align-self: flex-start;
      border-top-left-radius: 0;
    }
    .input-area {
      display: flex;
      padding: 12px 20px;
      background: white;
      border-top: 1px solid #ddd;
    }
    #mensaje {
      flex: 1;
      padding: 12px 16px;
      border-radius: 999px;
      border: 1px solid #ccc;
      font-size: 1rem;
      outline: none;
    }
    #sendBtn {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      background: #00B8FF;
      border: none;
      margin-left: 10px;
      display: flex;
      justify-content: center;
      align-items: center;
      cursor: pointer;
    }
    #sendBtn:hover {
      background: #0769b0;
    }
    #sendBtn svg {
      fill: white;
      width: 22px;
      height: 22px;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* Historial modal */
    .modal {
      position: fixed;
      top: 60px;
      right: 20px;
      background: white;
      border: 1px solid #ccc;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      padding: 15px;
      border-radius: 8px;
      z-index: 999;
      width: 300px;
      max-height: 60vh;
      overflow-y: auto;
    }
    .modal h3 {
      margin-bottom: 10px;
      font-size: 1.1rem;
    }
    .conversation-item {
      padding: 8px;
      background: #f0f0f0;
      margin-bottom: 6px;
      border-radius: 6px;
      cursor: pointer;
    }
    .conversation-item:hover {
      background: #e0e0e0;
    }
  </style>
</head>
<body>

  <header>
    <img src="Img/2.svg" alt="Logo" class="header-image" />
    <button class="history-btn" onclick="toggleHistorial()">☰</button>
  </header>

  <div class="chat-container" id="respuesta"></div>

  <div class="input-area">
  <input type="text" id="mensaje" placeholder="Pregunta a ¡Supérate!" />
  
  <button id="micBtn" aria-label="Hablar" style="margin-left: 10px; background: #00B8FF; border: none; border-radius: 50%; width: 48px; height: 48px; display: flex; align-items: center; justify-content: center; cursor: pointer;">
    <!-- Icono micrófono SVG -->
    <svg xmlns="http://www.w3.org/2000/svg" height="24" width="24" fill="white">
      <path d="M12 14q-1.25 0-2.125-.875T9 11V5q0-1.25.875-2.125T12 2q1.25 0 2.125.875T15 5v6q0 1.25-.875 2.125T12 14Zm-1 7v-3.05q-2.875-.35-4.688-2.488Q4.5 13.325 4.5 10.5h2q0 2.35 1.575 3.925Q9.65 16 12 16t3.925-1.575Q17.5 12.35 17.5 10.5h2q0 2.825-1.812 4.962Q15.875 17.6 13 17.95V21Z"/>
    </svg>
  </button>

  <button id="sendBtn" aria-label="Enviar">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
      <path d="M12 2L5 9h4v9h6V9h4l-7-7z"/>
    </svg>
  </button>
</div>


  <div class="modal" id="historialModal" style="display:none">
    <h3>Historial de conversaciones</h3>
    <div id="listaHistorial"></div>
  </div>

  <script>
    const mensajeInput = document.getElementById("mensaje");
    const sendBtn = document.getElementById("sendBtn");
    const respuestaDiv = document.getElementById("respuesta");

    let historialActual = [];
    let historialGuardado = JSON.parse(localStorage.getItem("conversacionesNorAI") || "[]");

    function guardarConversacion() {
      if (historialActual.length > 0) {
        historialGuardado.push([...historialActual]);
        localStorage.setItem("conversacionesNorAI", JSON.stringify(historialGuardado));
      }
    }

    function toggleHistorial() {
      const modal = document.getElementById("historialModal");
      modal.style.display = modal.style.display === "none" ? "block" : "none";
      mostrarHistorial();
    }

    function mostrarHistorial() {
      const lista = document.getElementById("listaHistorial");
      lista.innerHTML = "";
      historialGuardado.forEach((conv, index) => {
        const item = document.createElement("div");
        item.className = "conversation-item";
        item.textContent = conv[0]?.texto?.slice(0, 40) + "...";
        item.onclick = () => {
          historialActual = [...conv];
          renderConversacion();
          toggleHistorial();
        };
        lista.appendChild(item);
      });
    }

    function renderConversacion() {
      respuestaDiv.innerHTML = "";
      historialActual.forEach(msg => {
        const div = document.createElement("div");
        div.className = `message ${msg.tipo === 'user' ? 'user-message' : 'bot-message'}`;
        div.textContent = msg.texto;
        respuestaDiv.appendChild(div);
      });
      respuestaDiv.scrollTop = respuestaDiv.scrollHeight;
    }

    function enviar() {
      const texto = mensajeInput.value.trim();
      if (!texto) return;

      historialActual.push({ tipo: 'user', texto });
      renderConversacion();
      mensajeInput.value = "";

      // Loader
      historialActual.push({ tipo: 'bot', texto: "..." });
      renderConversacion();

      // Enviar al webhook con contexto
      fetch("https://hook.us2.make.com/48fv9qpdi1t0b5pb0c9uhhkb3o47csnw", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          mensaje: texto,
          contexto: historialActual.map(e => e.texto).join("\n")
        })
      })
      .then(res => res.text())
      .then(respuesta => {
        historialActual.pop();
        historialActual.push({ tipo: 'bot', texto: respuesta.trim() });
        renderConversacion();
      })
      .catch(err => {
        historialActual.pop();
        historialActual.push({ tipo: 'bot', texto: "❌ Error al responder." });
        renderConversacion();
        console.error(err);
      });
    }

    sendBtn.addEventListener("click", enviar);
    mensajeInput.addEventListener("keydown", e => {
      if (e.key === "Enter") {
        e.preventDefault();
        enviar();
      }
    });

    window.addEventListener("beforeunload", guardarConversacion);
    window.onload = renderConversacion;
    const micBtn = document.getElementById("micBtn");

const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
if (SpeechRecognition) {
  const recognition = new SpeechRecognition();
  recognition.lang = "es-ES";
  recognition.continuous = false;
  recognition.interimResults = false;

  micBtn.addEventListener("click", () => {
    recognition.start();
    micBtn.style.background = "#0077cc"; // cambia color al escuchar
  });

  recognition.onresult = (event) => {
    const textoVoz = event.results[0][0].transcript;
    mensajeInput.value = textoVoz;
    micBtn.style.background = "#00B8FF";

    // Puedes enviar automáticamente el mensaje aquí si quieres:
    enviar();
  };

  recognition.onerror = (e) => {
    console.error("Error en reconocimiento de voz:", e);
    micBtn.style.background = "#00B8FF";
  };

  recognition.onend = () => {
    micBtn.style.background = "#00B8FF";
  };
} else {
  micBtn.disabled = true;
  micBtn.title = "Tu navegador no soporta reconocimiento de voz";
}

  </script>
</body>
</html>
